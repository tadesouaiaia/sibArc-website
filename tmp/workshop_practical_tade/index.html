<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Tade Souaiaia" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Day 1 (PM) - SibArc</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Day 1 (PM)";
        var mkdocs_page_input_path = "tmp/workshop_practical_tade.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> SibArc
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Quick Start</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../quik_install/">Installation and Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../quik_demo/">Running SibArc</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../quik_result/">Interpreting Results</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../about_future/">Future Work</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Misc</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../workshop_practical_paul.docx/">Day 1 (AM)</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Day 1 (PM)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#table-of-contents">Table of Contents</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#key-learning-outcomes">Key Learning Outcomes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ex-1-portability-problem">Ex 1: Portability Problem</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ex-2-population-genetics">Ex 2: Population Genetics</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ex-3-pca">Ex 3: PCA</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../workshop_practical_clive.docx/">Day 2 (AM)</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">SibArc</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Misc</li>
      <li class="breadcrumb-item active">Day 1 (PM)</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/tadesouaiaia/sibArc-website/edit/master/docs/tmp/workshop_practical_tade.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="population-genetics-and-ancestry-analysis">Population Genetics And Ancestry Analysis</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#key-learning-outcomes">Key Learning Outcomes</a></li>
<li><a href="#practical-specific-data">Practical Data</a> </li>
<li><a href="#ex-1-portability-problem">A Portability Problem</a> </li>
<li><a href="#ex-2-population-genetics">Population Genetics Basics</a> </li>
<li><a href="#ex-3-pca">Dimensional Reduction: PCA</a> </li>
</ol>
<hr />
<h2 id="key-learning-outcomes">Key Learning Outcomes</h2>
<p>After completing this practical, you should be able to:</p>
<ol>
<li>Run mixed ancestry PRS and understand the PRS Portability Problem </li>
<li>Understand principle component analysis and dimensional reduction </li>
<li>Understand basic population genetics and know how to analyze ancestry groups. </li>
<li>Understand the challenges and limitations of applying PRS in populations with diverse genetic backgrounds.</li>
</ol>
<h5>Practical Specific Data</h5>

<p>The multi-ancestry data/software required for this practical can be downloaded here.  </p>
<p>Please download, unzip the data, and move it into a suitable directory on your laptop.  </p>
<p>After doing this you should see the following directories: </p>
<ul>
<li>exercise1: Data/Code to run multi-ancestry PRS    </li>
<li>exercise2: Data/Code for principal component analysis </li>
<li>exercise3: Data/Code for population genetics analysis </li>
</ul>
<hr />
<h2 id="ex-1-portability-problem">Ex 1: Portability Problem</h2>
<p>The first exercise of this practical takes place in the folder <strong>exercise1</strong>.  Once inside the folder you should 
see <strong>code</strong> and <strong>data</strong> directories.  Looking in the data directory by typing the following command will reveal: </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>ls data/*
</code></pre></div>
<ol>
<li>üá™üá∫: <strong>EURO_GWAS.assoc</strong> (European Ancestry GWAS Sumstats) </li>
<li>üá¨üáß: <strong>data/ukTarget</strong> (Genotype Phenotype data From a population from the UK.)</li>
<li>üáØüáµ: <strong>data/japanTarget</strong> (Genotype Phenotype data from a population from Japan.)</li>
</ol>
<p>To start, run PRSice using the European GWAS and target data from the UK: </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>./code/PRSice --base data/EURO_GWAS.assoc --target data/ukTarget/ukTarget --binary-target F --out ukRun
</code></pre></div>
<p>Verify that this command produce a file called <strong>"ukRun.best"</strong> that contains individual prs-scores in fourth column.  This file can 
compared to the file <strong>data/ukTarget/ukTarget.pheno</strong> which contains phenotype-values in the third column. </p>
<p>üö® OPTIONAL-CHALLENGE üö®</p>
<p>Using R, Python, or another program, consider calculating the correlation between the PRS and phenotype data in the two files? </p>
<ul>
<li>First read the pseudocode and see if you can follow the strategy. </li>
<li>Then give it a try or read the following solutions and make sure that you understand them.  </li>
<li>Notice the differences in similarities in the programming languages. </li>
</ul>
<div class="tabbed-set" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Hints</label><div class="tabbed-content">
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>#1) Step1: Read Both Files in. 
    prs_data = read(&#39;ukRun.best&#39;) 
    pheno_data = read(&quot;data/ukTarget/ukTarget.pheno&quot;)

#2) Step2: Extract the correct Column from each file .
    prs_vals = extract_from(prs_data, column 4) 
    pheno_vals = extract_from(pheno_data, column 3)

#3) Step3: Calculate the correlation. 
    R2 = calculate_R2_from_data(prs_vals, pheno_vals)
</code></pre></div>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Solution (R)</label><div class="tabbed-content">
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>R
# read-in prs-file 
prs &lt;- read.table(&quot;ukRun.best&quot;, header = TRUE, sep = &quot;&quot;, stringsAsFactors = FALSE)                                                                                                                                            
prs.data &lt;- prs1[,4]

# read-in pheno-file 
pheno &lt;- read.table(&quot;data/ukTarget/ukTarget.pheno&quot;, header = TRUE, sep = &quot;&quot;, stringsAsFactors = FALSE)                                                                                                                                          
pheno.data &lt;- pheno[,3]

# Create DataFrame 
combined_data &lt;- data.frame( x = prs.data,  y = pheno.data)

# Fit a linear model to the data                                                                                                                                                                                            
model &lt;- lm(y ~ x, data = combined_data)                                                                                                                                                                                    
# Calculate the R-squared value                                                                                                                                                                                             
r_squared &lt;- summary(model)$r.squared  
# return R2 
print(r_squared)
</code></pre></div>
</div>
<input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><label for="__tabbed_1_3">Solution (Python)</label><div class="tabbed-content">
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>python3
# read-in prs-file: 
with open(&#39;ukRun.best&#39;) as F:  
    prs_vals = [float(line.split()[-1]) for i,line in enumerate(F.readlines()) if i &gt; 0]

# read-in pheno-file: 
with open(&#39;data/ukTarget/ukTarget.pheno&#39;) as F:  
    pheno_vals = [float(line.split()[-1]) for i,line in enumerate(F.readlines()) if i &gt; 0]

# calculate correlation                                                                                                                                                                                                                
prs_mean, pheno_mean = sum(prs_vals)/len(prs_vals), sum(pheno_vals)/len(pheno_vals)                                                                                                                                     
rTop = sum([(x-prs_mean)*(y-pheno_mean) for x,y in zip(prs_vals, pheno_vals)])                                                                                                                                          
rBottom = (sum([(x-prs_mean)*(x-prs_mean) for x in prs_vals])**0.5) * (sum([(x-pheno_mean)*(x-pheno_mean) for x in pheno_vals])**0.5)

# Return R2                                                                                                                                                                                                               
R2 = (rTop/rBottom)*(rTop/rBottom)                                                                                                                                                                                                                                                                                                                                                                                                   
print(R2)
</code></pre></div>
</div>
</div>
<p>After you feel confident about the code, please run the Rscript in the code directory to calculate the correlation and 
create a scatterplot using the UK PRS-result: </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>Rscript --vanilla code/plot_prs_results.R data/ukTarget/ukTarget.pheno ukRun.best
</code></pre></div>
<p>This will create a scatterplot file called: <strong>ukRunScatterplot.pdf</strong>.  </p>
<p>Verify that you can view it, and then type the commands below to reuse the European GWAS data and PRSice with the genotype-phenotype data from a Japan.<br />
After viewing the resulting scatterplot please answer the questions below. </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>./code/PRSice --base data/EURO_GWAS.assoc --target data/japanTarget/japanTarget --binary-target F --out japanRun
Rscript --vanilla code/plot_prs_results.R data/japanTarget/japanTarget.pheno japanRun.best
</code></pre></div>
<p><strong>‚ùìQUESTIONS:</strong></p>
<details>
  <summary>In the UK-result, what percent of variance in phenotype is explained by prs?</summary>
  Approximately 10%. 
</details>

<details>
  <summary>In the Japan-result, what percent of variance in phenotype is explained by prs?</summary>
  Approximately 0%. 
</details>

<details>
  <summary>Besides a difference in variance explained, do you notice any other differences?</summary>
  Less variance in PRS, a shift to the left. 
</details>

<details>
  <summary>What is the name of the problem that refers to this drop in performance?</summary>
  The PRS Portability problem. 
</details>

<details>
  <summary>What are some causes of the problem?</summary>
  1. Differences in LD.
  2. Differences in allele frequency. 
  3. Differences in environment. 
  4. Differences in population-structure. 
</details>

<hr />
<p><a href="#top"><a href="#table-of-contents">Back to Top</a></a></p>
<h5>1000 Genomes Data</h5>

<p>Now that you have observed the PRS-portability problem in practice we are going to consider some analysis that can be used to 
provide a solution.  Recall from the lecture that population structure and population assignment is often accomplished using 
principal components analysis (PCA) and that the primary population differences that drive the portability problem are 
difference in allele frequency and linkage disequilibrium.  In the next exercise we will learn how to analyze and compare 
data from different populations and quantify linkage disequilibrium.  In the final exercise we what PCA is and learn how 
it can be used to separate population data by recent ancestry. Both of these exercises use the 1000Genomes dataset which contains individuals from 26 different 
source populations from all five continents. </p>
<hr />
<p><a href="#top"><a href="#table-of-contents">Back to Top</a></a></p>
<h2 id="ex-2-population-genetics">Ex 2: Population Genetics</h2>
<p>This exercise of this practical takes place in the folder <strong>exercise2</strong>.  Once inside the folder you should 
see <strong>code</strong> and <strong>data</strong> directories.  Looking in the data directory by typing the following command will reveal: </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>ls data/*
</code></pre></div>
<ol>
<li>üåé: <strong>chr1-22.bed/bim/fam</strong> (Global Genotype Data) </li>
<li>üè∑Ô∏è: <strong>data/pop_info.pheno</strong> (Population specific annotation data) </li>
<li>üí´: <strong>data/all_phase3.king.psam</strong> (Axillary Phase Data) </li>
</ol>
<h5>Sample Sizes</h5>

<p>The first thing we would like to find out about this data is the number of individuals within each global superpopulation.  Type the 
following command to query the number of European ancestry individuals in the downloaded dataset: </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>grep -F &quot;EUR&quot; data/all_phase3.king.psam | wc -l
</code></pre></div>
<p>Next, repeat the same command for East Asian, African, South Asian and Amerindian superpopulations, by inserting the relevant ancestry codes (EAS, AFR, SAS, AMR).</p>
<p>üóíÔ∏è Make note of how many individuals from each ancestry group are available. </p>
<h5>Number of Genetic Variants</h5>

<p>We do not need to use the full genome-wide data for this tutorial, only a small fraction 
of the 80 million total available variants. This provides a reliable approximation
for the genomic analyses in this tutorial and importantly, reduces the computation
time required to complete the tutorial. The following command derives the number
of genetic variants on chromosomes 1 to chromosome 22 by counting the number of
lines in the relevant (.bim) file, which contains a single variant per line.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>wc data/chr1-22.bim -l
</code></pre></div>
<p>To quantify the number of single nucleotide polymorphisms (SNPs) we can ask plink to write a
list of SNPs: </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>./code/plink --bfile data/chr1-22 --snps-only --write-snplist
</code></pre></div>
<p>See the output file plink.snplist, which contains a list of all the SNPs in the dataset. </p>
<h5>Quantification of variable SNPs</h5>

<p>The rate at which a genetic variant occurs in a population is also known as its allelic
frequency. Allele frequencies are shaped by evolutionary forces over a long period
of time and hence can vary. This has implications for PRS research as the allelic
frequency distribution of a disease or trait may vary between populations. It is
possible to generate allele frequency statistics for each SNP in a given population,
using the population information in the file pop_info.pheno.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>./code/plink --bfile data/chr1-22 --snps-only --freq --within data/pop_info.pheno
</code></pre></div>
<p>Population-stratified allele frequency results can be found in the output file plink.frq.strat.
For each population, print the numbers of total SNPs to screen, as follows:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>grep -F &quot;AFR&quot; plink.frq.strat | wc -l
</code></pre></div>
<p>Compare the totals against number of SNPs which have minor allele frequencies
greater than 0 (and hence are useful for statistical analysis). Do this for all 5
populations (EAS, EUR, SAS, EUR and AFR), using the code given below:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>grep -F  &quot;AFR&quot; plink.frq.strat &gt; freq_report.afr
grep -F &quot;AMR&quot; plink.frq.strat &gt; freq_report.amr
grep -F &quot;EUR&quot; plink.frq.strat &gt; freq_report.eur
grep -F &quot;EAS&quot; plink.frq.strat &gt; freq_report.eas
grep -F &quot;SAS&quot; plink.frq.strat &gt; freq_report.sas
grep -F &quot;AFR&quot; plink.frq.strat | awk &#39;$6 &gt;0&#39; freq_report.afr | wc -l
grep -F &quot;EUR&quot; plink.frq.strat | awk &#39;$6 &gt;0&#39; freq_report.eur | wc -l
grep -F &quot;EAS&quot; plink.frq.strat | awk &#39;$6 &gt;0&#39; freq_report.eas | wc -l
grep -F &quot;AMR&quot; plink.frq.strat | awk &#39;$6 &gt;0&#39; freq_report.amr | wc -l
grep -F &quot;SAS&quot; plink.frq.strat | awk &#39;$6 &gt;0&#39; freq_report.sas | wc -l
</code></pre></div>
<p>Having compared the number of SNPs that show variation in each population, answer the following questions: </p>
<p><strong>‚ùìQUESTIONS:</strong></p>
<details>
  <summary>Which populations have the largest number (density) of SNPs that can be considered polymorphic?</summary>
  AFR and AMR. 
</details>

<details>
  <summary>What do you think is the significance of the observed population order?</summary>
  Human evolution and migration. 
</details>

<hr />
<h5>Investigation Missingness</h5>

<p>Genotype missingness, caused by genotyping failure can potentially lead to biased
allele frequency estimation. Therefore missingness needs to be excluded as a possible
source of bias when calculating allele frequency differences.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>./code/plink --bfile data/chr1-22 --missing --within data/pop_info.pheno
</code></pre></div>
<p>The output file plink.lmiss provides a variant-based missing data report). Use the
following code to query the number of genotyping failures based on the missingness
information in the NMISS column:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>awk &#39;$4 &gt; 0&#39; plink.lmiss | wc -l
</code></pre></div>
<h5>Cross Population Allele Frequency Comparisons</h5>

<p>Here we compare profiles of allele frequency across the five ancestral populations.
To do this we will use the previously-generated output on minor allele frequencies
per ancestry group (the file "plink.frq.strat"), using R: </p>
<div class="admonition help">
<p class="admonition-title">R-Code: Compare Allele Frequencies</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>library(dplyr)
library(ggplot2)
freq &lt;-read.table(&quot;plink.frq.strat&quot;, header =T)
plotDat &lt;- freq %&gt;%
mutate(AlleleFrequency = cut(MAF, seq(0, 1, 0.25))) %&gt;%
group_by(AlleleFrequency, CLST) %&gt;%
summarise(FractionOfSNPs = n()/nrow(freq) * 100)

ggplot(na.omit(plotDat),aes(AlleleFrequency, FractionOfSNPs, group = CLST, col = CLST)) +
geom_line() + scale_y_continuous(limits = c(0, 12)) + ggtitle(&quot;Distribution of allele frequency across genome&quot;)
</code></pre></div>
</div>
<p><strong>‚ùìQUESTIONS:</strong></p>
<details>
  <summary>How are the allele frequencies in AFR distinguishable from the other global reference groups?</summary>
  Greater diversity. 
</details>

<h5>Linkage disequilibrium versus genomic distance, across populations</h5>

<p>We will now perform pairwise LD comparisons between genome-wide snps in order
to show cross-populations relationships between genomic distance and LD strength.
We derive information on pairwise R2 between all SNPs:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>./code/plink --bfile data/chr1-22 --keep-cluster-names AFR --within data/pop_info.pheno --r2 --ld-window-r2 0 --ld-window 999999 --ld-window-kb 2500 --threads 30 --out chr1-22.AFR
</code></pre></div>
<p>Repeat this step for all five 1000Genomes populations. Output files containing LD
info for all pairwise SNPs, have a ‚Äò.ld‚Äô suÔ¨Éx Next, create a summary file containing 
the base-pair distance between each pair and the corresponding r2 value. The
following example shows this for AFR and EUR populations only, as just these
populations will be used in the plot.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>cat chr1-22.AFR.ld | sed 1,1d | awk -F &quot; &quot; &#39;function abs(v) {return v &lt; 0 ? -v : v}BEGIN{OFS=&quot;\t&quot;}{print abs($5-$2),$7}&#39; | sort -k1,1n &gt; chr1-22.AFR.ld.summary
cat chr1-22.EUR.ld | sed 1,1d | awk -F &quot; &quot; &#39;function abs(v) {return v &lt; 0 ? -v : v}BEGIN{OFS=&quot;\t&quot;}{print abs($5-$2),$7}&#39; | sort -k1,1n &gt; chr1-22.EUR.ld.summary
</code></pre></div>
<h5>LD decay versus chromosomal distance</h5>

<p>To visualise LD behaviour as a function of chromosomal distance we can carry out 
the following commands from within an R terminal: </p>
<div class="admonition help">
<p class="admonition-title">R-Code: Visualize LD Behavior</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code># need to add additional functionality to be able to 
# carry out the necessary data transformation (dplyr) 
# and manipulation of character strings (stringr )

install.packages(&quot;dplyr&quot;)
install.packages(&quot;stringr&quot;)
install.packages(&quot;ggplot2&quot;)
library(dplyr)
library(stringr)
library(ggplot2)

# Next we will (1) load the previously generated information on pairwise LD, 
# Categorize distances into intervals of fixed length (100KB), 
# Compute mean and median r2 within blocks 
# Obrain mid-points for each distance interval

dfr&lt;-read.delim(&quot;chr1-22.AFR.ld.summary&quot;,sep=&quot;&quot;,header=F,check.names=F, stringsAsFactors=F)
colnames(dfr)&lt;-c(&quot;dist&quot;,&quot;rsq&quot;)
dfr$distc&lt;-cut(dfr$dist,breaks=seq(from=min(dfr$dist)-1,to=max(dfr$dist)+1,by=100000))
dfr1&lt;-dfr %&gt;% group_by(distc) %&gt;% summarise(mean=mean(rsq),median=median(rsq))
dfr1 &lt;- dfr1 %&gt;% mutate(start=as.integer(str_extract(str_replace_all(distc,&quot;[\\(\\)\\[\\]]&quot;,&quot;&quot;),&quot;^[0-9-e+.]+&quot;)),
                        end=as.integer(str_extract(str_replace_all(distc,&quot;[\\(\\)\\[\\]]&quot;,&quot;&quot;),&quot;[0-9-e+.]+$&quot;)),
                        mid=start+((end-start)/2))

# The preceding code block should be repeated for the file chr1-22._EUR.ld.summary.
# When doing so, the output object dfr1 on lines 4 and 5 should be renamed dfr2 to prevent the object df1 being over-written. 
# Finally, we can plot LD decay for AFR and EUR reference populations in a single graph:

ggplot()+
  geom_point(data=dfr1,aes(x=start,y=mean),size=0.4,colour=&quot;grey20&quot;)+
  geom_line(data=dfr1,aes(x=start,y=mean),size=0.3,alpha=0.5,colour=&quot;grey40&quot;)+
  labs(x=&quot;Distance (Megabases)&quot;,y=expression(LD~(r^{2})))+
  scale_x_continuous(breaks=c(0,2*10^6,4*10^6,6*10^6,8*10^6),labels=c(&quot;0&quot;,&quot;2&quot;,&quot;4&quot;,&quot;6&quot;,&quot;8&quot;))+
  theme_bw()
</code></pre></div>
</div>
<p><strong>‚ùìQUESTIONS:</strong></p>
<details>
  <summary>What differences do you observe in terms of LD decay between AFR and EUR genomes?</summary> 
  Greater decay in AFR 
</details>

<details>
  <summary>How is this likely to impact the transferability of PRS performance between the two populations?</summary>
  Negatively. 
</details>

<hr />
<h5>Distribution of LD-block length</h5>
<p>The next set of scripts will allow us to visualise the distribution of LD block length across different 1000Genomes populations.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>./code/plink --bfile chr1-22 --keep-cluster-names AFR --blocks no-pheno-req no-small-max-span --blocks-max-kb 250 --within data/pop_info.pheno  --threads 30 --out AFR
</code></pre></div>
<p>The ‚Äú‚Äìblock" flag estimates haplotype blocks using the same block definition implemented by the software Haploview. The default setting for the flag --blocks-max-kb
only considers pairs of variants that are within 200 kilobases of each other. The output file from the above command is a .blocks file. Use the same code to generate output 
for EUR, EAS, SAS and AMR populations (as it is not possible to generate population-specific information using the --within flag).
Then, in R:</p>
<div class="admonition help">
<p class="admonition-title">R-Code: Load each of the 5 datasets and set column names to lower case.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>dfr.afr &lt;- read.delim(&quot;AFR.blocks.det&quot;,sep=&quot;&quot;,header=T,check.names=F,stringsAsFactors=F) 
colnames(dfr.afr) &lt;- tolower(colnames(dfr.afr))

dfr.eur &lt;- read.delim(&quot;EUR.blocks.det&quot;,sep=&quot;&quot;,header=T,check.names=F,stringsAsFactors=F)
colnames(dfr.eur) &lt;- tolower(colnames(dfr.eur))

dfr.amr &lt;- read.delim(&quot;AMR.blocks.det&quot;,sep=&quot;&quot;,header=T,check.names=F,stringsAsFactors=F)
colnames(dfr.amr) &lt;- tolower(colnames(dfr.amr))

dfr.sas &lt;- read.delim(&quot;SAS.blocks.det&quot;,sep=&quot;&quot;,header=T,check.names=F,stringsAsFactors=F)
colnames(dfr.sas) &lt;- tolower(colnames(dfr.sas))

dfr.eas &lt;- read.delim(&quot;EAS.blocks.det&quot;,sep=&quot;&quot;,header=T,check.names=F,stringsAsFactors=F)
colnames(dfr.eas) &lt;- tolower(colnames(dfr.eas))
</code></pre></div>
<p>Then plot the data: </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>plot (density(dfr.afr$kb), main=&quot;LD block length distribution&quot;, ylab=&quot;Density&quot;,xlab=&quot;LD block length (Kb)&quot; )
lines (density(dfr.eur$kb), col=&quot;blue&quot;)
lines (density(dfr.eas$kb), col=&quot;red&quot;)
lines (density(dfr.amr$kb), col=&quot;purple&quot;)
lines (density(dfr.sas$kb), col=&quot;green&quot;)
legend(&quot;topright&quot;,c(&quot;AFR&quot;,&quot;EAS&quot;,&quot;EUR&quot;,&quot;SAS&quot;,&quot;AMR&quot;), 
fill=c(&quot;black&quot;,&quot;red&quot;,&quot;blue&quot;,&quot;green&quot;,&quot;purple&quot;))
</code></pre></div>
</div>
<p><strong>‚ùìQUESTIONS:</strong></p>
<details>
  <summary>What are the main features of this plot?  How do you interpret them?</summary> 
  Open ended 
</details>

<hr />
<p><a href="#top"><a href="#table-of-contents">Back to Top</a></a></p>
<h2 id="ex-3-pca">Ex 3: PCA</h2>
<p>Principle Component Analysis is a useful technique that allows researchers to visualize high dimensional data in lower space by rotating the axes in such a 
way that the lower dimensions (or components) maximize the total variance explained.  In statistical genetics this involves "rotating" million-dimensional 
data - something that is very hard to visualize!  For this reason, we begin with a simpler exercise.  For the following three two dimensional shapes, 
spend some time identifying the principle components or sketching the line across for which variance is maximized.   Check your answers below: </p>
<p><img alt="Screenshot" src="../images2/basic_pca_shapes.png" /> </p>
<p><strong>‚ùìQUESTIONS:</strong></p>
<details>
  <summary>What line represents the principle component for the first shape?</summary> 
  The line 4/3(x) + y   
</details>

<details>
  <summary>What line represents the principle component for the second shape?</summary> 
  The line x+y. 
</details>

<details>
  <summary>What line represents the principle component for the third shape?</summary> 
  The X and Y axis already maximize the variance. 
</details>

<p>Below you can view the shapes in principal component space. </p>
<p><img alt="Screenshot" src="../images2/basicResult.png" /> </p>
<p>Now that we understand how PCA works in two dimensions we will consider a higher dimensional example.  In the three dimensional space below, see if you can visualize a plane that maximizes the variance 
across two dimensions:   </p>
<p><img alt="Screenshot" src="../images2/test3d_noPlane.png" /> </p>
<p>Did you get it right? If so, realize that this is equivalent to what we do in genetics - we find rotate the data through millions of dimensions of space to find the plane 
that maximizes the variance in two dimensions:  </p>
<p><img alt="Screenshot" src="../images2/test3d_plane.png" /> </p>
<p>To run PCA with real data please enter the <strong>exercise2</strong> directory, and type the following command to run PCA on the 1000 Genome data: </p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>plink --bfile data/chr1-22 --indep-pairwise 250 25 0.1 --maf 0.1 --threads 30 --out chr1-22.ldpruned_all_1kgv2
plink --bfile data/chr1-22 --extract chr1-22.ldpruned_all_1kgv2.prune.in  --pca --threads 30
</code></pre></div>
<p>This will generate the principal components that maximize the variance in the data.  To plot the result run the following commands from with an R-terminal: </p>
<div class="admonition help">
<p class="admonition-title">R-Code: Generate a PCA Plot</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>require(&#39;RColorBrewer&#39;)
options(scipen=100, digits=3)
eigenvec &lt;- read.table(&#39;plink.eigenvec&#39;, header = F, skip=0, sep = &#39; &#39;)
rownames(eigenvec) &lt;- eigenvec[,2]
eigenvec &lt;- eigenvec[,3:ncol(eigenvec)]
colnames(eigenvec) &lt;- paste(&#39;Principal Component &#39;, c(1:20), sep = &#39;&#39;)

PED &lt;- read.table(&quot;data/all_phase3.king.psam&quot;, header = TRUE, skip = 0, sep = &#39;\t&#39;)
PED &lt;- PED[which(PED$IID %in% rownames(eigenvec)), ]
PED &lt;- PED[match(rownames(eigenvec), PED$IID),]

PED$Population &lt;- factor(PED$Population, levels=c(&quot;ACB&quot;,&quot;ASW&quot;,&quot;ESN&quot;,&quot;GWD&quot;,&quot;LWK&quot;,&quot;MSL&quot;,&quot;YRI&quot;,&quot;CLM&quot;,&quot;MXL&quot;,&quot;PEL&quot;,&quot;PUR&quot;,&quot;CDX&quot;,&quot;CHB&quot;,&quot;CHS&quot;,&quot;JPT&quot;,&quot;KHV&quot;,&quot;CEU&quot;,&quot;FIN&quot;,&quot;GBR&quot;,&quot;IBS&quot;,&quot;TSI&quot;,&quot;BEB&quot;,&quot;GIH&quot;,&quot;ITU&quot;,&quot;PJL&quot;,&quot;STU&quot;))

col &lt;- colorRampPalette(c(&quot;yellow&quot;,&quot;yellow&quot;,&quot;yellow&quot;,&quot;yellow&quot;,&quot;yellow&quot;,&quot;yellow&quot;,&quot;yellow&quot;,&quot;forestgreen&quot;,&quot;forestgreen&quot;,&quot;forestgreen&quot;,&quot;forestgreen&quot;,&quot;grey&quot;,&quot;grey&quot;,&quot;grey&quot;,&quot;grey&quot;,&quot;grey&quot;,
&quot;royalblue&quot;,&quot;royalblue&quot;,&quot;royalblue&quot;,&quot;royalblue&quot;,&quot;royalblue&quot;,&quot;black&quot;,&quot;black&quot;,&quot;black&quot;,&quot;black&quot;,&quot;black&quot;))(length(unique(PED$Population)))[factor(PED$Population)]

project.pca &lt;- eigenvec
par(mar = c(5,5,5,5), cex = 2.0,cex.main = 7, cex.axis = 2.75, cex.lab = 2.75, mfrow = c(1,2))

plot(project.pca[,1], project.pca[,2],
     type = &#39;n&#39;,
     main = &#39;A&#39;,
     adj = 0.5,
     xlab = &#39;First component&#39;,
     ylab = &#39;Second component&#39;,
     font = 2,
     font.lab = 2)
points(project.pca[,1], project.pca[,2], col = col, pch = 20, cex = 2.25)
legend(&#39;bottomright&#39;,
       bty = &#39;n&#39;,
       cex = 3.0,
       title = &#39;&#39;,
       c(&#39;AFR&#39;, &#39;AMR&#39;, &#39;EAS&#39;,
         &#39;EUR&#39;, &#39;SAS&#39;),
       fill = c(&#39;yellow&#39;, &#39;forestgreen&#39;, &#39;grey&#39;, &#39;royalblue&#39;, &#39;black&#39;))

plot(project.pca[,1], project.pca[,3],
     type=&quot;n&quot;,
     main=&quot;B&quot;,
     adj=0.5,
     xlab=&quot;First component&quot;,
     ylab=&quot;Third component&quot;,
     font=2,
     font.lab=2)
points(project.pca[,1], project.pca[,3], col=col, pch=20, cex=2.25)
</code></pre></div>
</div>
<p><strong>‚ùìQUESTIONS:</strong></p>
<details>
  <summary>What is distinct about the PC projects of the AMR group relative to other populations?</summary> 
  Greater Distance, Overlap. 
</details>

<details>
  <summary>Why does this occur? What does it tell us about ancestry of this group?</summary> 
  Suggest recent admixture? 
</details>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../workshop_practical_paul.docx/" class="btn btn-neutral float-left" title="Day 1 (AM)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../workshop_practical_clive.docx/" class="btn btn-neutral float-right" title="Day 2 (AM)">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/tadesouaiaia/sibArc-website" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../workshop_practical_paul.docx/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../workshop_practical_clive.docx/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      <script src="../../javascripts/details.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
